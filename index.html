<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yapper Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #1c1e21;
            --text-sub: #65676b; --border: #dddfe2; --header-bg: #ffffff;
            --msg-sent: #0084ff; --sent-text: #ffffff; --msg-received: #ffffff;
        }
        /* Dark Mode Colors */
        [data-theme="dark"] {
            --bg-body: #18191a; --bg-card: #242526; --text-main: #e4e6eb;
            --text-sub: #b0b3b8; --border: #3e4042; --header-bg: #242526;
            --msg-received: #3e4042;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s; }
        .view { display: none; flex-direction: column; height: 100%; width: 100%; }
        
        /* UI Elements */
        .profile-bar { padding: 10px 15px; display: flex; align-items: center; gap: 12px; background: var(--header-bg); border-bottom: 1px solid var(--border); }
        .avatar-circle { width: 45px; height: 45px; border-radius: 50%; background: #1877f2; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        #profile-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 100; display: none; text-align: center; width: 80%; max-width: 300px; color: var(--text-main); }
        .picker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        
        .item-row { padding: 12px 15px; display: flex; align-items: center; gap: 12px; background: var(--bg-card); border-bottom: 1px solid var(--border); cursor: pointer; position: relative; }
        .friend-meta { flex: 1; min-width: 0; }
        .last-msg { font-size: 13px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .unread-dot { width: 10px; height: 10px; background: #0084ff; border-radius: 50%; flex-shrink: 0; display: none; }

        /* Chat Bubbles */
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: var(--bg-body); }
        .msg { padding: 8px 14px 18px 14px; font-size: 15px; max-width: 75%; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); animation: pop 0.2s ease-out; }
        .sent { background: var(--msg-sent); color: var(--sent-text); align-self: flex-end; border-radius: 18px 18px 4px 18px; }
        .received { background: var(--msg-received); color: var(--text-main); align-self: flex-start; border-radius: 18px 18px 18px 4px; border: 1px solid var(--border); }
        .time { position: absolute; bottom: 4px; right: 10px; font-size: 10px; opacity: 0.7; }
        .received .time { left: 10px; right: auto; color: var(--text-sub); }

        .input-area { padding: 10px 10px 35px 10px; background: var(--header-bg); display: flex; gap: 10px; border-top: 1px solid var(--border); }
        .styled-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); outline: none; margin-bottom: 10px; }
        .btn-blue { color: #0084ff; background: none; border: none; font-weight: bold; cursor: pointer; }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="profile-modal">
        <h3>Edit Profile</h3>
        <input type="text" id="edit-nickname" class="styled-input" placeholder="Nickname">
        <div class="picker-grid">
            <div onclick="setTempAvatar('üê∂')">üê∂</div><div onclick="setTempAvatar('üê±')">üê±</div>
            <div onclick="setTempAvatar('ü§ñ')">ü§ñ</div><div onclick="setTempAvatar('üëª')">üëª</div>
            <div onclick="setTempAvatar('üòé')">üòé</div><div onclick="setTempAvatar('üëë')">üëë</div>
            <div onclick="setTempAvatar('üçï')">üçï</div><div onclick="setTempAvatar('‚öΩ')">‚öΩ</div>
        </div>
        <button onclick="saveProfile()" style="width:100%; background:#0084ff; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold;">Save</button>
        <button onclick="toggleDarkMode()" style="width:100%; margin-top:10px; padding:8px; border:1px solid var(--border); border-radius:8px; background:none; color:var(--text-main);">Toggle Dark Mode</button>
        <button onclick="closeModal()" style="margin-top:10px; background:none; border:none; color:var(--text-sub);">Cancel</button>
    </div>

    <div id="auth-view" class="view" style="display:flex; justify-content:center; align-items:center;">
        <div style="text-align:center; width:80%;">
            <h1 style="color:#1877f2; font-size:45px; margin:0;">Yapper</h1>
            <p style="color:var(--text-sub); margin-bottom:20px;">Private messaging.</p>
            <input type="email" id="email" placeholder="Email" class="styled-input">
            <input type="password" id="password" placeholder="Password" class="styled-input">
            <button id="btn-login" style="width:100%; background:#1877f2; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold;">Log In</button>
            <p id="btn-signup" style="color:#42b72a; cursor:pointer; font-weight:bold; margin-top:20px;">Create Account</p>
        </div>
    </div>

    <div id="home-view" class="view">
        <div class="profile-bar">
            <div id="my-avatar-circle" class="avatar-circle" onclick="openModal()">?</div>
            <div style="flex:1;"><div id="my-display-name" style="font-weight:bold;">Nickname</div><div style="font-size:10px; color:var(--text-sub);">Tap to edit</div></div>
            <button id="btn-logout" class="btn-blue">Logout</button>
        </div>
        <div style="padding:15px; display:flex; gap:8px;">
            <input type="text" id="search-input" placeholder="Friend's email..." class="styled-input" style="flex:1; margin-bottom:0; border-radius:20px;">
            <button id="btn-search" class="btn-blue">Search</button>
        </div>
        <div id="request-area" style="display:none; padding:15px; background:#e7f3ff; border-radius:10px; margin: 0 15px; color: #1c1e21;"><small>Requests:</small><div id="request-list"></div></div>
        <div id="friend-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div id="chat-view" class="view">
        <div class="profile-bar">
            <button id="btn-back" class="btn-blue" style="font-size:22px;">‚Üê</button>
            <div id="chat-avatar" class="avatar-circle" style="width:35px; height:35px; font-size:18px;">?</div>
            <div style="flex:1"><strong id="chat-target-name">Chat</strong></div>
            <button id="btn-mute" class="btn-blue" style="font-size:18px; margin-right:15px;">üîî</button>
            <button id="btn-delete" style="background:none; border:none; font-size:18px; cursor:pointer;">üóëÔ∏è</button>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Aa" style="flex:1; padding:12px; border-radius:25px; border:1px solid var(--border); background:var(--bg-body); color:var(--text-main); outline:none;">
            <button id="btn-send" class="btn-blue" style="font-size:18px;">‚û§</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDocs, deleteDoc, getDoc, updateDoc, limit, writeBatch } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB98LWEjfYaG_wbkMkwo0QJ4ch8VhQO-IA",
            authDomain: "messengerapp-dcccc.firebaseapp.com",
            projectId: "messengerapp-dcccc",
            storageBucket: "messengerapp-dcccc.firebasestorage.app",
            messagingSenderId: "255835922798",
            appId: "1:255835922798:web:d9293fc275ae2b18fa617f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let activeChatId = null, unsubscribeChat = null, tempAvatar = 'üë§', mutedChats = JSON.parse(localStorage.getItem('muted_yapper') || '{}');

        // Toggle Dark Mode Logic
        window.toggleDarkMode = () => {
            const current = document.body.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', target);
            localStorage.setItem('yapper_theme', target);
        };
        if(localStorage.getItem('yapper_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

        function formatTime(ts) { if (!ts) return ""; const d = ts.toDate(); return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                switchView('home-view');
                const uSnap = await getDoc(doc(db, "users", user.uid));
                if (uSnap.exists()) { updateUI(uSnap.data()); }
                else { const d = { email: user.email, uid: user.uid, avatar: 'üë§', nickname: user.email.split('@')[0] }; await setDoc(doc(db, "users", user.uid), d); updateUI(d); }
                loadFriends(); loadRequests();
            } else { switchView('auth-view'); }
        });

        function updateUI(data) {
            document.getElementById('my-display-name').innerText = data.nickname;
            document.getElementById('my-avatar-circle').innerText = data.avatar;
            document.getElementById('edit-nickname').value = data.nickname;
            tempAvatar = data.avatar;
        }

        window.openModal = () => document.getElementById('profile-modal').style.display = 'block';
        window.closeModal = () => document.getElementById('profile-modal').style.display = 'none';
        window.setTempAvatar = (icon) => tempAvatar = icon;
        window.saveProfile = async () => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { nickname: document.getElementById('edit-nickname').value, avatar: tempAvatar });
            closeModal();
        };

        function loadFriends() {
            onSnapshot(collection(db, "users", auth.currentUser.uid, "friends"), (snap) => {
                const list = document.getElementById('friend-list'); list.innerHTML = '';
                snap.forEach(async d => {
                    const f = d.data();
                    const fSnap = await getDoc(doc(db, "users", f.uid));
                    const fData = fSnap.data();
                    const roomId = [auth.currentUser.uid, f.uid].sort().join('_');
                    const div = document.createElement('div');
                    div.className = 'item-row';
                    div.innerHTML = `<div class="avatar-circle" style="width:40px;height:40px;font-size:16px;">${fData.avatar}</div><div class="friend-meta"><strong>${fData.nickname} ${mutedChats[roomId] ? 'üîï' : ''}</strong><span class="last-msg" id="last-${roomId}">...</span></div><div class="unread-dot" id="dot-${roomId}"></div>`;
                    div.onclick = () => openChat(fData, roomId);
                    list.appendChild(div);
                    onSnapshot(query(collection(db, "chats", roomId, "messages"), orderBy("timestamp", "desc"), limit(1)), (mSnap) => {
                        if (!mSnap.empty) {
                            const m = mSnap.docs[0].data();
                            document.getElementById(`last-${roomId}`).innerText = (m.sender === auth.currentUser.uid ? "You: " : "") + m.text;
                            if (m.sender !== auth.currentUser.uid && activeChatId !== roomId && !mutedChats[roomId]) document.getElementById(`dot-${roomId}`).style.display = 'block';
                        }
                    });
                });
            });
        }

        function openChat(friend, roomId) {
            activeChatId = roomId; switchView('chat-view');
            document.getElementById('chat-target-name').innerText = friend.nickname;
            document.getElementById('chat-avatar').innerText = friend.avatar;
            if(document.getElementById(`dot-${roomId}`)) document.getElementById(`dot-${roomId}`).style.display = 'none';
            document.getElementById('btn-mute').innerText = mutedChats[roomId] ? 'üîï' : 'üîî';
            if (unsubscribeChat) unsubscribeChat();
            const q = query(collection(db, "chats", roomId, "messages"), orderBy("timestamp", "asc"));
            unsubscribeChat = onSnapshot(q, (snap) => {
                const msgDiv = document.getElementById('messages'); msgDiv.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data(); const time = formatTime(m.timestamp);
                    const div = document.createElement('div'); div.className = `msg ${m.sender === auth.currentUser.uid ? 'sent' : 'received'}`;
                    div.innerHTML = `${m.text} <span class="time">${time}</span>`;
                    msgDiv.appendChild(div);
                });
                msgDiv.scrollTop = msgDiv.scrollHeight;
            });
        }

        document.getElementById('btn-send').onclick = () => {
            const i = document.getElementById('msg-input');
            if (i.value.trim() && activeChatId) { addDoc(collection(db, "chats", activeChatId, "messages"), { text: i.value, sender: auth.currentUser.uid, timestamp: serverTimestamp() }); i.value = ''; }
        };

        document.getElementById('btn-mute').onclick = () => {
            if (mutedChats[activeChatId]) delete mutedChats[activeChatId]; else mutedChats[activeChatId] = true;
            localStorage.setItem('muted_yapper', JSON.stringify(mutedChats)); loadFriends();
            document.getElementById('btn-mute').innerText = mutedChats[activeChatId] ? 'üîï' : 'üîî';
        };

        document.getElementById('btn-delete').onclick = async () => {
            if (confirm("Clear chat for you and friend?")) {
                const q = await getDocs(collection(db, "chats", activeChatId, "messages"));
                const batch = writeBatch(db); q.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }
        };

        window.accept = async (id, fId, fEmail) => {
            await setDoc(doc(db, "users", auth.currentUser.uid, "friends", fId), { uid: fId, email: fEmail });
            await setDoc(doc(db, "users", fId, "friends", auth.currentUser.uid), { uid: auth.currentUser.uid, email: auth.currentUser.email });
            await deleteDoc(doc(db, "requests", id));
        };
        
        function loadRequests() {
            onSnapshot(query(collection(db, "requests"), where("to", "==", auth.currentUser.uid)), (snap) => {
                const area = document.getElementById('request-area'); area.style.display = snap.empty ? 'none' : 'block';
                const list = document.getElementById('request-list'); list.innerHTML = '';
                snap.forEach(d => { const r = d.data(); const div = document.createElement('div'); div.style="display:flex;justify-content:space-between;margin-top:5px;";
                div.innerHTML = `<span>${r.fromEmail}</span> <button class="btn-blue" onclick="accept('${d.id}','${r.from}','${r.fromEmail}')">Accept</button>`;
                list.appendChild(div); });
            });
        }

        function switchView(id) { document.querySelectorAll('.view').forEach(v => v.style.display = 'none'); document.getElementById(id).style.display = 'flex'; }
        document.getElementById('btn-back').onclick = () => { activeChatId = null; switchView('home-view'); };
        document.getElementById('btn-login').onclick = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(alert);
        document.getElementById('btn-signup').onclick = () => createUserWithEmailAndPassword(auth, email.value, password.value).catch(alert);
        document.getElementById('btn-logout').onclick = () => signOut(auth);
        document.getElementById('btn-search').onclick = async () => {
            const em = document.getElementById('search-input').value.toLowerCase().trim();
            const q = query(collection(db, "users"), where("email", "==", em));
            const snap = await getDocs(q);
            if (snap.empty) return alert("User not found");
            const t = snap.docs[0].data(); await setDoc(doc(db, "requests", t.uid + "_" + auth.currentUser.uid), { to: t.uid, from: auth.currentUser.uid, fromEmail: auth.currentUser.email });
            alert("Request sent!");
        };
    </script>
</body>
</html>
